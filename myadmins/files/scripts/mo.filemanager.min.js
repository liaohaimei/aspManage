var FilesArray=[];var currentpath="/";var actionurl="files/filemanager.asp?sessionid="+sessionid+"&action=";var filelist="filelists";var Lists=[];var pagesize=10;var Sort="name asc";function FileSystem(b,d,a,c){this.name=b||"";this.displayName=b||"";this.size=d||0;this.createtime=a||"";this.modtime=c||"";this.id=FileSystem.instance.length;this.isfolder=false;this.isparent=false;this.file_item=null;FileSystem.instance.push(this)}FileSystem.prototype.show=function(d){var c="unknown";var b="";var a=this;if(this.isfolder){c="folder";if(this.file_item!=null){b="空";if(this.file_item.folderscount+this.file_item.filescount>0){b=FileSystem.parseCount(this.file_item.folderscount,this.file_item.filescount)}b='<span class="details">('+b+")</span>"}}else{if(this.name.indexOf(".")>0){c=this.name.substr(this.name.lastIndexOf("."));c=c.replace(".","")}}c=c.toLowerCase();if(this.isparent){c="up"}$("#"+d).append('<div class="list fl" id="File'+this.id+'" class="clearfix"><div class="checkbox">'+(this.isparent?'':'<input type="checkbox" value="'+ this.id +'" name="filenames" />')+'</div><div class="w_name fp fp-'+c+'" onclick="'+(this.isfolder?"":"return;")+"Init('"+(this.isparent?"..":this.name)+'\');"><span class="filename">'+this.displayName+b+'</span><img style="display:'+((this.isparent||this.isfolder)?'none':'')+'" align="right" src="files/images/blank.gif"  border="0" onload="setimg(this,300,46,\'/upload'+ currentpath + this.name +'\')"/></div><div class="w_size"><span class="filesize">'+(this.isfolder?"":formatBytes(this.size))+'</span></div><div class="w_createdate">'+this.createtime+"</div></div>");$("#File"+this.id).hover(function(){$(this).css({"background-color":"#ffe"})},function(){if(!$(this).find('input').attr("checked")){$(this).css({"background-color":"#fff"})}}).bind("contextmenu",function(f){FileSystem.contextmenu.open.apply(a,[f]);return false})};FileSystem.prototype.download=function(){if(this.isfolder){return false}window.open("files/download.asp?path="+escape(currentpath+this.name),"_blank")};FileSystem.prototype.delall = function(a) {
    a === false || (a = true);
    Ajax({
        url: actionurl + (this.isfolder ? "folder": "file") + "_delete",
        data: "path=" + encodeURIComponent(currentpath + this.name),
        dataType: "json",
        showfinished: a,
        succeed: function(c, b) {
            if (!c) {
                alert("System Error")
            } else {
                if (c.err) {
                    FileSystem.Error(c.desc)
                } else {
                    //Init()
                }
            }
        },
        error: function(d, c) {
            alert("Server Error")
        }
    })
};FileSystem.prototype.del=function(a){a===false||(a=true);Ajax({url:actionurl+(this.isfolder?"folder":"file")+"_delete",data:"path="+encodeURIComponent(currentpath+this.name),dataType:"json",showfinished:a,succeed:function(c,b){if(!c){alert("System Error")}else{if(c.err){FileSystem.Error(c.desc)}else{if(this.showfinished){$("#dialog").html("文件(夹)删除成功！").dialog({buttons:{"确定":function(){$(this).dialog("close")}}});window.setTimeout(function(){$("#dialog").dialog("close")},1000)}else{$("#dialog").dialog("close")}Init()}}},error:function(d,c){alert("Server Error")}})};FileSystem.prototype.rename=function(a){var b="path="+encodeURIComponent(currentpath)+"&name="+encodeURIComponent(this.name)+"&newname="+encodeURIComponent(a);if(this.isfolder){b="path="+encodeURIComponent(currentpath+this.name)+"&newname="+encodeURIComponent(a)}Ajax({url:actionurl+(this.isfolder?"folder":"file")+"_rename",data:b,dataType:"json",succeed:function(d,c){if(!d){alert("System Error")}else{if(d.err){FileSystem.Error(d.desc)}else{if(this.showfinished){$("#dialog").html("文件(夹)重命名成功！").dialog({buttons:{"确定":function(){$(this).dialog("close")}}});window.setTimeout(function(){$("#dialog").dialog("close")},1000)}else{$("#dialog").dialog("close")}Init()}}},error:function(d,c){alert("Server Error")}})};FileSystem.prototype.create=function(){var a=this;if(!this.isfolder){return false}Ajax({url:actionurl+"folder_create",data:"path="+encodeURIComponent(currentpath+this.name),dataType:"json",succeed:function(c,b){if(!c){alert("System Error")}else{if(c.err){FileSystem.Error(c.desc)}else{$("#dialog").html("文件夹创建成功").dialog({buttons:{"确定":function(){$(this).dialog("close")}}});window.setTimeout(function(){$("#dialog").dialog("close")},1000);Init("")}}},error:function(d,c){alert("Server Error")}})};FileSystem.prototype.load=function(b){var a=this;if(!this.isfolder){return}$("#load_process").attr("src","files/images/loading.gif");Ajax({url:actionurl+"folder_load",data:"path="+encodeURIComponent(currentpath+this.name),dataType:"json",succeed:function(c){if(!c){alert("System Error")}else{if(c.err){FileSystem.Error(c.desc)}else{Lists=c.list;currentpath=currentpath+a.name+"/";currentpath=currentpath.replace("//","/");$("#path").html(FileSystem.parsePath()+'<span class="details">'+FileSystem.parseCount(c.folderscount,c.filescount)+"</span>");cookie("currentpath",currentpath)}FileSystem.Sort("name")}},error:function(d,c){alert("Server Error")}})};FileSystem.instance=[];FileSystem.Dialog={};FileSystem.contextmenu={};FileSystem.contextmenu.open=function(c){$(document).bind("click",FileSystem.contextmenu.close);var d=Exists("filesystem_contextmenu");if(!d){d=document.createElement("div");document.body.appendChild(d);d.id="filesystem_contextmenu"}var b=!(this.name==""||this.name=="...返回上级目录");var a="";if(b){a='<div class="cm_name">'+this.name+"</div>"+a;if(this.isfolder){a+="<div onclick=\"Init('"+(this.name.indexOf("...")>=0?"..":this.name)+'\');"><img src="files/images/blank.gif" class="ico ico_open" title="打开文件夹" /> 打开文件夹</div>'}if(!this.isfolder){a+='<div onclick="FileSystem.instance['+this.id+'].download();" style="display:none;"><img src="files/images/blank.gif" class="ico ico_download" title="下载文件" /> 下载文件</div>'}a+='<div onclick="FileSystem.Dialog.Rename('+this.id+');"><img src="files/images/blank.gif" class="ico ico_rename" title="重命名" /> 重命名</div>';a+='<div onclick="FileSystem.Dialog.Delete('+this.id+');" class="cm_split"><img src="files/images/blank.gif" class="ico ico_delete" title="删除" /> 删除</div>'}a+='<div onclick="FileSystem.Dialog.CreateFolder();"><img src="files/images/blank.gif" class="ico ico_createmenu" title="新建文件夹" /> 新建文件夹</div>';a+='<div onclick="InitUpload();" class="cm_split"><img src="files/images/blank.gif" class="ico ico_uploadmenu" title="上传文件" /> 上传文件</div>';a+='<div onclick="Init();"><img src="files/images/blank.gif" class="ico ico_refresh" title="刷新当前文件夹" /> 刷新</div>';a+='<div onclick="FileSystem.Dialog.Search();"><img src="files/images/blank.gif" class="ico ico_search" title="搜索" /> 搜索</div>';if(b){a+='<div onclick="FileSystem.Dialog.Attr('+this.id+');"><img src="files/images/blank.gif" class="ico ico_attr" title="属性" /> 属性</div>'}d.innerHTML=a;d.style.display="block";d.style.left=c.pageX+"px";d.style.top=c.pageY+"px"};FileSystem.contextmenu.close=function(){$(document).unbind("click",FileSystem.contextmenu.close);var a=Exists("filesystem_contextmenu");if(a){a.style.display="none"}};FileSystem.parseCount=function(d,c){var e="";if(d>0){e+=d+"个文件夹,"}if(c>0){e+=c+"个文件,"}if(e!=""){e=e.substr(0,e.length-1)}return e};FileSystem.SortByString=function(a){if(a==undefined){FileSystem.Sort("name")}var d="name",c=true;if(typeof a=="string"){a=$.trim(a).replace(/(\s+)/igm," ");var b=a.split(" ");if(b.length>=1){d=b[0]}if(b.length>=2){c=(b[1]=="asc")}}else{if(typeof a=="object"){if(a.name!=undefined){d=a.name}if(a.asc!=undefined){d=a.asc}}}FileSystem.Sort(d,c)};FileSystem.Sort=function(d,e){if(e!==false){e=true}for(var c=0;c<Lists.length-1;c++){for(var a=c+1;a<Lists.length;a++){if((Lists[c].isfolder||Lists[a].isfolder)&&d=="size"){continue}var f=((gt(Lists[c][d],Lists[a][d])>0)==e);if(f){var b=(Lists[c]);Lists[c]=(Lists[a]);Lists[a]=b}}}if(d=="name"||d=="size"){for(var c=1;c<Lists.length;c++){if(Lists[c].isfolder){a=c-1;while(a>=0&&!Lists[a].isfolder){var b=(Lists[a+1]);Lists[a+1]=(Lists[a]);Lists[a]=b;a--}}}}FileSystem.show(1)};FileSystem.createIco=function(a,b){return'<img src="files/images/blank.gif" class="ico '+a+'" title="'+b+'" /> '+b};FileSystem.parsePath=function(e){if(e==undefined){e=currentpath}e=e.replace(/\\/igm,"/");if(e==""){e="/"}e=e.replace(/^(\s*)\/|\/(\s*)$/igm,"");var a=e.split("/");var b="<a href=\"javascript:Init('/')\">根目录</a>";if(e==""){return b}var d="";for(var c=0;c<a.length;c++){d+="/"+a[c];b+=" / <a href=\"javascript:Init('"+d+"')\">"+a[c]+"</a>"}return b};FileSystem.pagestr=function(f,b){var a=Lists;if(b!=undefined&&b.constructor&&b.constructor==Array){a=b}if(a.length<=0){return""}if(f==undefined){f=1}var e=Math.ceil(a.length/pagesize);if(e<=1){return""}if(f<=0){f=1}if(f>e){f=e}var c="";for(var d=1;d<=e;d++){c+='<a href="javascript:FileSystem.show('+d+');"'+(d==f?' style="font-weight:bold"':"")+">"+d+"</a> | "}if(c!=""){c=c.substr(0,c.length-3)}return c};FileSystem.clear=function(){$(".fl").each(function(){this.parentNode.removeChild(this)});while(FileSystem.instance.length>0){FileSystem.instance.pop()}var a=new FileSystem("...返回上级目录","","","");a.isfolder=true;a.isparent=true;a.show(filelist)};FileSystem.show=function(h,b){FileSystem.clear();var a=Lists;if(b!=undefined&&b.constructor&&b.constructor==Array){a=b}if(h==undefined){h=1}var g=Math.ceil(a.length/pagesize);if(h<=0){h=1}if(h>g){h=g}$("#page").html(FileSystem.pagestr(h,b));if(Lists.length>0){var d=(h-1)*pagesize;for(var f=d,c=1;f<a.length&&c<=pagesize;f++,c++){var e=new FileSystem(a[f].name,a[f].size,a[f].create,a[f].mod);e.isfolder=a[f].isfolder;e.file_item=a[f];e.show(filelist)}}$("#load_process").attr("src","files/images/right.png")};FileSystem.Dialog.DeleteAll=function(b){var a=FileSystem.instance[b];if(!a){return};a.delall()};FileSystem.Dialog.Delete=function(b){var a=FileSystem.instance[b];if(!a){return}$("#dialog").html('文件(夹)名：<br /><span class="red">'+a.name+"</span>").dialog({minWidth:280,minHeight:140,resizable:false,modal:true,draggable:true,title:"删除文件/文件夹",buttons:{"立即删除":function(){a.del()},"取消":function(){$(this).dialog("close")}}})};FileSystem.Dialog.Attr=function(e){var c=FileSystem.instance[e];if(!c){return}if(c.name==""){return}if(c.name=="...返回上级目录"){return}var a="名称："+c.name;if(!c.isfolder){a+="<br />大小："+c.size+"字节("+formatBytes(c.size)+")"}else{if(c.file_item!=null){var b="空";if(c.file_item.folderscount+c.file_item.filescount>0){b=FileSystem.parseCount(c.file_item.folderscount,c.file_item.filescount)}}a+="<br />包含："+b}if(c.createtime!=""){a+="<br />创建："+c.createtime}if(c.modtime!=""){a+="<br />修改："+c.modtime}var d={};d["删除"]=function(){FileSystem.Dialog.Delete(e)};d["重命名"]=function(){FileSystem.Dialog.Rename(e)};d["取消"]=function(){$(this).dialog("close")};$("#dialog").html(a).dialog({minWidth:280,minHeight:140,resizable:false,modal:true,draggable:true,title:"属性",buttons:d})};FileSystem.Dialog.CreateFolder=function(){$("#dialog").html("当前路径："+currentpath+'<br />文件夹名：<input type="text" id="t_foldername" class="inputText" />').dialog({minWidth:280,minHeight:140,resizable:false,modal:true,draggable:true,title:"新建文件夹",buttons:{"立即创建":function(){var a=new FileSystem($("#t_foldername").val());a.isfolder=true;a.create()},"取消":function(){$(this).dialog("close")}}})};FileSystem.Dialog.Rename=function(b){var a=FileSystem.instance[b];if(!a){return}$("#dialog").html("原文件(夹)名："+a.name+'<br />新文件(夹)名：<input type="text" id="t_newname" class="inputText" value="'+a.name+'" />').dialog({minWidth:280,minHeight:140,resizable:false,modal:true,draggable:true,title:"重命名文件(夹)",buttons:{"立即重命名":function(c){a.rename($("#t_newname").val())},"取消":function(){$(this).dialog("close")}}})};FileSystem.Dialog.Search=function(){$("#dialog").html("当前路径："+currentpath+'<br />搜索名称：<input type="text" id="t_searchname" class="inputText" />').dialog({minWidth:280,minHeight:140,resizable:false,modal:true,draggable:true,title:"文件/文件夹搜索",buttons:{"搜索":function(){FileSystem.Search($("#t_searchname").val())},"取消":function(){$(this).dialog("close")}}})};FileSystem.Search=function(e){e=$.trim(e);if(Lists.length<=0){return}FileSystem.clear();$("#load_process").attr("src","files/images/loading.gif");var a=false;var d=new RegExp("("+e+")","i");for(var c=0;c<Lists.length;c++){if(Lists[c].name.toLowerCase().indexOf(e.toLowerCase())>=0||e==""){var b=new FileSystem(Lists[c].name,Lists[c].size,Lists[c].create,Lists[c].mod);b.isfolder=Lists[c].isfolder;b.file_item=Lists[c];b.displayName=Lists[c].name.replace(d,'<span class="red">$1</span>',1);b.show(filelist);a=true}}if(!a){var b=new FileSystem("",0,"","");b.displayName="未搜索到匹配项。";b.show(filelist)}$("#dialog").dialog("close");$("#load_process").attr("src","files/images/right.png")};FileSystem.Error=function(b){var a=b.split("_");if(a.length<4){return}var c=[];if(a[0]=="file"){c.push("文件操作：")}if(a[0]=="session"){c.push("会话状态：")}if(a[0]=="folder"){c.push("文件夹操作：")}if(a[1]=="delete"){c.push("删除")}if(a[1]=="get"){c.push("获取")}if(a[1]=="rename"){c.push("重命名")}if(a[1]=="create"){c.push("创建")}if(a[2]=="error"){c.push("错误")}if(a[2]=="succeed"){c.push("成功")}switch(a[3]){case"root":c.push("-根目录不允许本操作。");break;case"system":c.push("-系统错误。");break;case"value":c.push("- 值为空。");break;case"exists":c.push((a[4]=="true"?"-目标已存在。":"-目标不存在。"));break;case"name":c.push((a[4]=="empty"?"-文件(夹)名字不能为空。":(a[4]=="format"?"-文件(夹)名字格式错误。":"-文件(夹)名字未更改")));break}alert(c.join(""))};function InitUpload(){$("#upload").html('<iframe name="upload" frameborder="0" src="files/uploadform.asp?sessionid='+sessionid+"&r="+Math.random()+'" width="580" height="310"></iframe>').dialog({minWidth:580,minHeight:340,resizable:false,modal:true,draggable:true,buttonId:"buttons",create:function(){$("#buttons").append('<span id="result"></span>')},buttons:{"关闭":function(){$(this).dialog("close");$("#result").html("")}}})}function CallBack(a){if(this.length>0){Init()}$("#result").html("<span>成功上传 "+this.length+" 个文件！</span>")}function Init(a){if(a==".."){if(currentpath=="/"){return}currentpath=currentpath.replace(/(\/)([^\/]+?)(\/)?$/igm,"/");a=""}if(a==undefined){a=""}if(a.indexOf("/")==0){currentpath=a;a=""}var b=new FileSystem((a==undefined?"":a));b.isfolder=true;b.load()}function DoSort(d,c){var a=$(d).attr("rel");var b=c;if(a==""||a==c){b=c.replace(" desc"," asc")}FileSystem.SortByString(b);$(d).attr("rel",b);if(b.indexOf("asc")>0){$(d).find(".ico16").removeClass("ico_desc").addClass("ico_asc")}else{$(d).find(".ico16").removeClass("ico_asc").addClass("ico_desc")}FileSystem.show(1)}function BlankBind(a){FileSystem.contextmenu.open.apply(new FileSystem("",0,"",""),[a]);return false}function gt(e,d){if(typeof e=="number"){return e-d}if(typeof e=="string"){if(e==""&&d!=""){return -1}if(d==""&&e!=""){return 1}if(e==""&&d==""){return 0}var c=(e.length>d.length?d.length:e.length);e=e.toLowerCase();d=d.toLowerCase();var g=0;for(var f=0;f<c;f++){if(e.charCodeAt(f)>d.charCodeAt(f)){g=1;break}if(e.charCodeAt(f)<d.charCodeAt(f)){g=-1;break}}if(g==0&&e.length!=d.length){g=-1;if(e.length>d.length){g=1}}return g}return -1};